FSS={FRONT:0,BACK:1,DOUBLE:2,SVGNS:"http://www.w3.org/2000/svg"};FSS.Array=typeof Float32Array==="function"?Float32Array:Array;FSS.Utils={isNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)}};(function(){var e=0;var t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n){window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(t,n){var r=(new Date).getTime();var i=Math.max(0,16-(r-e));var s=window.setTimeout(function(){t(r+i)},i);e=r+i;return s}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(e){clearTimeout(e)}}})();Math.PIM2=Math.PI*2;Math.PID2=Math.PI/2;Math.randomInRange=function(e,t){return e+(t-e)*Math.random()};Math.clamp=function(e,t,n){e=Math.max(e,t);e=Math.min(e,n);return e};FSS.Vector3={create:function(e,t,n){var r=new FSS.Array(3);this.set(r,e,t,n);return r},clone:function(e){var t=this.create();this.copy(t,e);return t},set:function(e,t,n,r){e[0]=t||0;e[1]=n||0;e[2]=r||0;return this},setX:function(e,t){e[0]=t||0;return this},setY:function(e,t){e[1]=t||0;return this},setZ:function(e,t){e[2]=t||0;return this},copy:function(e,t){e[0]=t[0];e[1]=t[1];e[2]=t[2];return this},add:function(e,t){e[0]+=t[0];e[1]+=t[1];e[2]+=t[2];return this},addVectors:function(e,t,n){e[0]=t[0]+n[0];e[1]=t[1]+n[1];e[2]=t[2]+n[2];return this},addScalar:function(e,t){e[0]+=t;e[1]+=t;e[2]+=t;return this},subtract:function(e,t){e[0]-=t[0];e[1]-=t[1];e[2]-=t[2];return this},subtractVectors:function(e,t,n){e[0]=t[0]-n[0];e[1]=t[1]-n[1];e[2]=t[2]-n[2];return this},subtractScalar:function(e,t){e[0]-=t;e[1]-=t;e[2]-=t;return this},multiply:function(e,t){e[0]*=t[0];e[1]*=t[1];e[2]*=t[2];return this},multiplyVectors:function(e,t,n){e[0]=t[0]*n[0];e[1]=t[1]*n[1];e[2]=t[2]*n[2];return this},multiplyScalar:function(e,t){e[0]*=t;e[1]*=t;e[2]*=t;return this},divide:function(e,t){e[0]/=t[0];e[1]/=t[1];e[2]/=t[2];return this},divideVectors:function(e,t,n){e[0]=t[0]/n[0];e[1]=t[1]/n[1];e[2]=t[2]/n[2];return this},divideScalar:function(e,t){if(t!==0){e[0]/=t;e[1]/=t;e[2]/=t}else{e[0]=0;e[1]=0;e[2]=0}return this},cross:function(e,t){var n=e[0];var r=e[1];var i=e[2];e[0]=r*t[2]-i*t[1];e[1]=i*t[0]-n*t[2];e[2]=n*t[1]-r*t[0];return this},crossVectors:function(e,t,n){e[0]=t[1]*n[2]-t[2]*n[1];e[1]=t[2]*n[0]-t[0]*n[2];e[2]=t[0]*n[1]-t[1]*n[0];return this},min:function(e,t){if(e[0]<t){e[0]=t}if(e[1]<t){e[1]=t}if(e[2]<t){e[2]=t}return this},max:function(e,t){if(e[0]>t){e[0]=t}if(e[1]>t){e[1]=t}if(e[2]>t){e[2]=t}return this},clamp:function(e,t,n){this.min(e,t);this.max(e,n);return this},limit:function(e,t,n){var r=this.length(e);if(t!==null&&r<t){this.setLength(e,t)}else if(n!==null&&r>n){this.setLength(e,n)}return this},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},normalise:function(e){return this.divideScalar(e,this.length(e))},negate:function(e){return this.multiplyScalar(e,-1)},distanceSquared:function(e,t){var n=e[0]-t[0];var r=e[1]-t[1];var i=e[2]-t[2];return n*n+r*r+i*i},distance:function(e,t){return Math.sqrt(this.distanceSquared(e,t))},lengthSquared:function(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]},length:function(e){return Math.sqrt(this.lengthSquared(e))},setLength:function(e,t){var n=this.length(e);if(n!==0&&t!==n){this.multiplyScalar(e,t/n)}return this}};FSS.Vector4={create:function(e,t,n,r){var i=new FSS.Array(4);this.set(i,e,t,n);return i},set:function(e,t,n,r,i){e[0]=t||0;e[1]=n||0;e[2]=r||0;e[3]=i||0;return this},setX:function(e,t){e[0]=t||0;return this},setY:function(e,t){e[1]=t||0;return this},setZ:function(e,t){e[2]=t||0;return this},setW:function(e,t){e[3]=t||0;return this},add:function(e,t){e[0]+=t[0];e[1]+=t[1];e[2]+=t[2];e[3]+=t[3];return this},multiplyVectors:function(e,t,n){e[0]=t[0]*n[0];e[1]=t[1]*n[1];e[2]=t[2]*n[2];e[3]=t[3]*n[3];return this},multiplyScalar:function(e,t){e[0]*=t;e[1]*=t;e[2]*=t;e[3]*=t;return this},min:function(e,t){if(e[0]<t){e[0]=t}if(e[1]<t){e[1]=t}if(e[2]<t){e[2]=t}if(e[3]<t){e[3]=t}return this},max:function(e,t){if(e[0]>t){e[0]=t}if(e[1]>t){e[1]=t}if(e[2]>t){e[2]=t}if(e[3]>t){e[3]=t}return this},clamp:function(e,t,n){this.min(e,t);this.max(e,n);return this}};FSS.Color=function(e,t){this.rgba=FSS.Vector4.create();this.hex=e||"#000000";this.opacity=FSS.Utils.isNumber(t)?t:1;this.set(this.hex,this.opacity)};FSS.Color.prototype={set:function(e,t){e=e.replace("#","");var n=e.length/3;this.rgba[0]=parseInt(e.substring(n*0,n*1),16)/255;this.rgba[1]=parseInt(e.substring(n*1,n*2),16)/255;this.rgba[2]=parseInt(e.substring(n*2,n*3),16)/255;this.rgba[3]=FSS.Utils.isNumber(t)?t:this.rgba[3];return this},hexify:function(e){var t=Math.ceil(e*255).toString(16);if(t.length===1){t="0"+t}return t},format:function(){var e=this.hexify(this.rgba[0]);var t=this.hexify(this.rgba[1]);var n=this.hexify(this.rgba[2]);this.hex="#"+e+t+n;return this.hex}};FSS.Object=function(){this.position=FSS.Vector3.create()};FSS.Object.prototype={setPosition:function(e,t,n){FSS.Vector3.set(this.position,e,t,n);return this}};FSS.Light=function(e,t){FSS.Object.call(this);this.ambient=new FSS.Color(e||"#FFFFFF");this.diffuse=new FSS.Color(t||"#FFFFFF");this.ray=FSS.Vector3.create()};FSS.Light.prototype=Object.create(FSS.Object.prototype);FSS.Vertex=function(e,t,n){this.position=FSS.Vector3.create(e,t,n)};FSS.Vertex.prototype={setPosition:function(e,t,n){FSS.Vector3.set(this.position,e,t,n);return this}};FSS.Triangle=function(e,t,n){this.a=e||new FSS.Vertex;this.b=t||new FSS.Vertex;this.c=n||new FSS.Vertex;this.vertices=[this.a,this.b,this.c];this.u=FSS.Vector3.create();this.v=FSS.Vector3.create();this.centroid=FSS.Vector3.create();this.normal=FSS.Vector3.create();this.color=new FSS.Color;this.polygon=document.createElementNS(FSS.SVGNS,"polygon");this.polygon.setAttributeNS(null,"stroke-linejoin","round");this.polygon.setAttributeNS(null,"stroke-miterlimit","1");this.polygon.setAttributeNS(null,"stroke-width","1");this.computeCentroid();this.computeNormal()};FSS.Triangle.prototype={computeCentroid:function(){this.centroid[0]=this.a.position[0]+this.b.position[0]+this.c.position[0];this.centroid[1]=this.a.position[1]+this.b.position[1]+this.c.position[1];this.centroid[2]=this.a.position[2]+this.b.position[2]+this.c.position[2];FSS.Vector3.divideScalar(this.centroid,3);return this},computeNormal:function(){FSS.Vector3.subtractVectors(this.u,this.b.position,this.a.position);FSS.Vector3.subtractVectors(this.v,this.c.position,this.a.position);FSS.Vector3.crossVectors(this.normal,this.u,this.v);FSS.Vector3.normalise(this.normal);return this}};FSS.Geometry=function(){this.vertices=[];this.triangles=[];this.dirty=false};FSS.Geometry.prototype={update:function(){if(this.dirty){var e,t;for(e=this.triangles.length-1;e>=0;e--){t=this.triangles[e];t.computeCentroid();t.computeNormal()}this.dirty=false}return this}};FSS.Plane=function(e,t,n,r){FSS.Geometry.call(this);this.width=e||100;this.height=t||100;this.segments=n||4;this.slices=r||4;this.segmentWidth=this.width/this.segments;this.sliceHeight=this.height/this.slices;var i,s,o,u,a,f,l,c,h=[],p=this.width*-.5,d=this.height*.5;for(i=0;i<=this.segments;i++){h.push([]);for(s=0;s<=this.slices;s++){l=new FSS.Vertex(p+i*this.segmentWidth,d-s*this.sliceHeight);h[i].push(l);this.vertices.push(l)}}for(i=0;i<this.segments;i++){for(s=0;s<this.slices;s++){o=h[i+0][s+0];u=h[i+0][s+1];a=h[i+1][s+0];f=h[i+1][s+1];t0=new FSS.Triangle(o,u,a);t1=new FSS.Triangle(a,u,f);this.triangles.push(t0,t1)}}};FSS.Plane.prototype=Object.create(FSS.Geometry.prototype);FSS.Material=function(e,t){this.ambient=new FSS.Color(e||"#444444");this.diffuse=new FSS.Color(t||"#FFFFFF");this.slave=new FSS.Color};FSS.Mesh=function(e,t){FSS.Object.call(this);this.geometry=e||new FSS.Geometry;this.material=t||new FSS.Material;this.side=FSS.FRONT;this.visible=true};FSS.Mesh.prototype=Object.create(FSS.Object.prototype);FSS.Mesh.prototype.update=function(e,t){var n,r,i,s,o;this.geometry.update();if(t){for(n=this.geometry.triangles.length-1;n>=0;n--){r=this.geometry.triangles[n];FSS.Vector4.set(r.color.rgba);for(i=e.length-1;i>=0;i--){s=e[i];FSS.Vector3.subtractVectors(s.ray,s.position,r.centroid);FSS.Vector3.normalise(s.ray);o=FSS.Vector3.dot(r.normal,s.ray);if(this.side===FSS.FRONT){o=Math.max(o,0)}else if(this.side===FSS.BACK){o=Math.abs(Math.min(o,0))}else if(this.side===FSS.DOUBLE){o=Math.max(Math.abs(o),0)}FSS.Vector4.multiplyVectors(this.material.slave.rgba,this.material.ambient.rgba,s.ambient.rgba);FSS.Vector4.add(r.color.rgba,this.material.slave.rgba);FSS.Vector4.multiplyVectors(this.material.slave.rgba,this.material.diffuse.rgba,s.diffuse.rgba);FSS.Vector4.multiplyScalar(this.material.slave.rgba,o);FSS.Vector4.add(r.color.rgba,this.material.slave.rgba)}FSS.Vector4.clamp(r.color.rgba,0,1)}}return this};FSS.Scene=function(){this.meshes=[];this.lights=[]};FSS.Scene.prototype={add:function(e){if(e instanceof FSS.Mesh&&!~this.meshes.indexOf(e)){this.meshes.push(e)}else if(e instanceof FSS.Light&&!~this.lights.indexOf(e)){this.lights.push(e)}return this},remove:function(e){if(e instanceof FSS.Mesh&&~this.meshes.indexOf(e)){this.meshes.splice(this.meshes.indexOf(e),1)}else if(e instanceof FSS.Light&&~this.lights.indexOf(e)){this.lights.splice(this.lights.indexOf(e),1)}return this}};FSS.Renderer=function(){this.width=0;this.height=0;this.halfWidth=0;this.halfHeight=0};FSS.Renderer.prototype={setSize:function(e,t){if(this.width===e&&this.height===t)return;this.width=e;this.height=t;this.halfWidth=this.width*.5;this.halfHeight=this.height*.5;return this},clear:function(){return this},render:function(e){return this}};FSS.CanvasRenderer=function(){FSS.Renderer.call(this);this.element=document.createElement("canvas");this.element.style.display="block";this.context=this.element.getContext("2d");this.setSize(this.element.width,this.element.height)};FSS.CanvasRenderer.prototype=Object.create(FSS.Renderer.prototype);FSS.CanvasRenderer.prototype.setSize=function(e,t){FSS.Renderer.prototype.setSize.call(this,e,t);this.element.width=e;this.element.height=t;this.context.setTransform(1,0,0,-1,this.halfWidth,this.halfHeight);return this};FSS.CanvasRenderer.prototype.clear=function(){FSS.Renderer.prototype.clear.call(this);this.context.clearRect(-this.halfWidth,-this.halfHeight,this.width,this.height);return this};FSS.CanvasRenderer.prototype.render=function(e){FSS.Renderer.prototype.render.call(this,e);var t,n,r,i,s;this.clear();this.context.lineJoin="round";this.context.lineWidth=1;for(t=e.meshes.length-1;t>=0;t--){n=e.meshes[t];if(n.visible){n.update(e.lights,true);for(r=n.geometry.triangles.length-1;r>=0;r--){i=n.geometry.triangles[r];s=i.color.format();this.context.beginPath();this.context.moveTo(i.a.position[0],i.a.position[1]);this.context.lineTo(i.b.position[0],i.b.position[1]);this.context.lineTo(i.c.position[0],i.c.position[1]);this.context.closePath();this.context.strokeStyle=s;this.context.fillStyle=s;this.context.stroke();this.context.fill()}}}return this};FSS.WebGLRenderer=function(){FSS.Renderer.call(this);this.element=document.createElement("canvas");this.element.style.display="block";this.vertices=null;this.lights=null;var e={preserveDrawingBuffer:false,premultipliedAlpha:true,antialias:true,stencil:true,alpha:true};this.gl=this.getContext(this.element,e);this.unsupported=!this.gl;if(this.unsupported){return"WebGL is not supported by your browser."}else{this.gl.clearColor(0,0,0,0);this.gl.enable(this.gl.DEPTH_TEST);this.setSize(this.element.width,this.element.height)}};FSS.WebGLRenderer.prototype=Object.create(FSS.Renderer.prototype);FSS.WebGLRenderer.prototype.getContext=function(e,t){var n=false;try{if(!(n=e.getContext("experimental-webgl",t))){throw"Error creating WebGL context."}}catch(r){console.error(r)}return n};FSS.WebGLRenderer.prototype.setSize=function(e,t){FSS.Renderer.prototype.setSize.call(this,e,t);if(this.unsupported)return;this.element.width=e;this.element.height=t;this.gl.viewport(0,0,e,t);return this};FSS.WebGLRenderer.prototype.clear=function(){FSS.Renderer.prototype.clear.call(this);if(this.unsupported)return;this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);return this};FSS.WebGLRenderer.prototype.render=function(e){FSS.Renderer.prototype.render.call(this,e);if(this.unsupported)return;var t,n,r,i,s,o,u,a,f,l,c,h,p=false,d=e.lights.length,v,m,g,y,b=0;this.clear();if(this.lights!==d){this.lights=d;if(this.lights>0){this.buildProgram(d)}else{return}}if(!!this.program){for(t=e.meshes.length-1;t>=0;t--){n=e.meshes[t];if(n.geometry.dirty)p=true;n.update(e.lights,false);b+=n.geometry.triangles.length*3}if(p||this.vertices!==b){this.vertices=b;for(a in this.program.attributes){l=this.program.attributes[a];l.data=new FSS.Array(b*l.size);v=0;for(t=e.meshes.length-1;t>=0;t--){n=e.meshes[t];for(r=0,i=n.geometry.triangles.length;r<i;r++){s=n.geometry.triangles[r];for(m=0,g=s.vertices.length;m<g;m++){vertex=s.vertices[m];switch(a){case"side":this.setBufferData(v,l,n.side);break;case"position":this.setBufferData(v,l,vertex.position);break;case"centroid":this.setBufferData(v,l,s.centroid);break;case"normal":this.setBufferData(v,l,s.normal);break;case"ambient":this.setBufferData(v,l,n.material.ambient.rgba);break;case"diffuse":this.setBufferData(v,l,n.material.diffuse.rgba);break}v++}}}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,l.buffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,l.data,this.gl.DYNAMIC_DRAW);this.gl.enableVertexAttribArray(l.location);this.gl.vertexAttribPointer(l.location,l.size,this.gl.FLOAT,false,0,0)}}this.setBufferData(0,this.program.uniforms.resolution,[this.width,this.height,this.width]);for(o=d-1;o>=0;o--){u=e.lights[o];this.setBufferData(o,this.program.uniforms.lightPosition,u.position);this.setBufferData(o,this.program.uniforms.lightAmbient,u.ambient.rgba);this.setBufferData(o,this.program.uniforms.lightDiffuse,u.diffuse.rgba)}for(f in this.program.uniforms){l=this.program.uniforms[f];h=l.location;c=l.data;switch(l.structure){case"3f":this.gl.uniform3f(h,c[0],c[1],c[2]);break;case"3fv":this.gl.uniform3fv(h,c);break;case"4fv":this.gl.uniform4fv(h,c);break}}}this.gl.drawArrays(this.gl.TRIANGLES,0,this.vertices);return this};FSS.WebGLRenderer.prototype.setBufferData=function(e,t,n){if(FSS.Utils.isNumber(n)){t.data[e*t.size]=n}else{for(var r=n.length-1;r>=0;r--){t.data[e*t.size+r]=n[r]}}};FSS.WebGLRenderer.prototype.buildProgram=function(e){if(this.unsupported)return;var t=FSS.WebGLRenderer.VS(e);var n=FSS.WebGLRenderer.FS(e);var r=t+n;if(!!this.program&&this.program.code===r)return;var i=this.gl.createProgram();var s=this.buildShader(this.gl.VERTEX_SHADER,t);var o=this.buildShader(this.gl.FRAGMENT_SHADER,n);this.gl.attachShader(i,s);this.gl.attachShader(i,o);this.gl.linkProgram(i);if(!this.gl.getProgramParameter(i,this.gl.LINK_STATUS)){var u=this.gl.getError();var a=this.gl.getProgramParameter(i,this.gl.VALIDATE_STATUS);console.error("Could not initialise shader.\nVALIDATE_STATUS: "+a+"\nERROR: "+u);return null}this.gl.deleteShader(o);this.gl.deleteShader(s);i.code=r;i.attributes={side:this.buildBuffer(i,"attribute","aSide",1,"f"),position:this.buildBuffer(i,"attribute","aPosition",3,"v3"),centroid:this.buildBuffer(i,"attribute","aCentroid",3,"v3"),normal:this.buildBuffer(i,"attribute","aNormal",3,"v3"),ambient:this.buildBuffer(i,"attribute","aAmbient",4,"v4"),diffuse:this.buildBuffer(i,"attribute","aDiffuse",4,"v4")};i.uniforms={resolution:this.buildBuffer(i,"uniform","uResolution",3,"3f",1),lightPosition:this.buildBuffer(i,"uniform","uLightPosition",3,"3fv",e),lightAmbient:this.buildBuffer(i,"uniform","uLightAmbient",4,"4fv",e),lightDiffuse:this.buildBuffer(i,"uniform","uLightDiffuse",4,"4fv",e)};this.program=i;this.gl.useProgram(this.program);return i};FSS.WebGLRenderer.prototype.buildShader=function(e,t){if(this.unsupported)return;var n=this.gl.createShader(e);this.gl.shaderSource(n,t);this.gl.compileShader(n);if(!this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS)){console.error(this.gl.getShaderInfoLog(n));return null}return n};FSS.WebGLRenderer.prototype.buildBuffer=function(e,t,n,r,i,s){var o={buffer:this.gl.createBuffer(),size:r,structure:i,data:null};switch(t){case"attribute":o.location=this.gl.getAttribLocation(e,n);break;case"uniform":o.location=this.gl.getUniformLocation(e,n);break}if(!!s){o.data=new FSS.Array(s*r)}return o};FSS.WebGLRenderer.VS=function(e){var t=["precision mediump float;","#define LIGHTS "+e,"attribute float aSide;","attribute vec3 aPosition;","attribute vec3 aCentroid;","attribute vec3 aNormal;","attribute vec4 aAmbient;","attribute vec4 aDiffuse;","uniform vec3 uResolution;","uniform vec3 uLightPosition[LIGHTS];","uniform vec4 uLightAmbient[LIGHTS];","uniform vec4 uLightDiffuse[LIGHTS];","varying vec4 vColor;","void main() {","vColor = vec4(0.0);","vec3 position = aPosition / uResolution * 2.0;","for (int i = 0; i < LIGHTS; i++) {","vec3 lightPosition = uLightPosition[i];","vec4 lightAmbient = uLightAmbient[i];","vec4 lightDiffuse = uLightDiffuse[i];","vec3 ray = normalize(lightPosition - aCentroid);","float illuminance = dot(aNormal, ray);","if (aSide == 0.0) {","illuminance = max(illuminance, 0.0);","} else if (aSide == 1.0) {","illuminance = abs(min(illuminance, 0.0));","} else if (aSide == 2.0) {","illuminance = max(abs(illuminance), 0.0);","}","vColor += aAmbient * lightAmbient;","vColor += aDiffuse * lightDiffuse * illuminance;","}","vColor = clamp(vColor, 0.0, 1.0);","gl_Position = vec4(position, 1.0);","}"].join("\n");return t};FSS.WebGLRenderer.FS=function(e){var t=["precision mediump float;","varying vec4 vColor;","void main() {","gl_FragColor = vColor;","}"].join("\n");return t};FSS.SVGRenderer=function(){FSS.Renderer.call(this);this.element=document.createElementNS(FSS.SVGNS,"svg");this.element.setAttribute("xmlns",FSS.SVGNS);this.element.setAttribute("version","1.1");this.element.style.display="block";this.setSize(300,150)};FSS.SVGRenderer.prototype=Object.create(FSS.Renderer.prototype);FSS.SVGRenderer.prototype.setSize=function(e,t){FSS.Renderer.prototype.setSize.call(this,e,t);this.element.setAttribute("width",e);this.element.setAttribute("height",t);return this};FSS.SVGRenderer.prototype.clear=function(){FSS.Renderer.prototype.clear.call(this);for(var e=this.element.childNodes.length-1;e>=0;e--){this.element.removeChild(this.element.childNodes[e])}return this};FSS.SVGRenderer.prototype.render=function(e){FSS.Renderer.prototype.render.call(this,e);var t,n,r,i,s,o;for(t=e.meshes.length-1;t>=0;t--){n=e.meshes[t];if(n.visible){n.update(e.lights,true);for(r=n.geometry.triangles.length-1;r>=0;r--){i=n.geometry.triangles[r];if(i.polygon.parentNode!==this.element){this.element.appendChild(i.polygon)}s=this.formatPoint(i.a)+" ";s+=this.formatPoint(i.b)+" ";s+=this.formatPoint(i.c);o=this.formatStyle(i.color.format());i.polygon.setAttributeNS(null,"points",s);i.polygon.setAttributeNS(null,"style",o)}}}return this};FSS.SVGRenderer.prototype.formatPoint=function(e){return this.halfWidth+e.position[0]+","+(this.halfHeight-e.position[1])};FSS.SVGRenderer.prototype.formatStyle=function(e){var t="fill:"+e+";";t+="stroke:"+e+";";return t}